<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poetic Mind</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* èƒŒæ™¯æ˜Ÿæ˜Ÿæ•ˆæœ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(88, 177, 116, 0.5), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(13, 252, 97, 0.5), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(225, 189, 9, 0.6), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(216, 1, 117, 0.5), transparent),
        radial-gradient(2px 2px at 160px 30px, rgba(218, 12, 110, 0.5), transparent),
        radial-gradient(1px 1px at 200px 60px, rgba(149, 77, 111, 0.1), transparent),
        radial-gradient(2px 2px at 240px 90px, rgba(148, 237, 13, 0.5), transparent);
      background-repeat: repeat;
      background-size: 250px 100px;
      animation: twinkle 4s ease-in-out infinite alternate;
      z-index: 1;
    }

    @keyframes twinkle {
      0% { opacity: 0.3; }
      100% { opacity: 0.8; }
    }

    /* åå…­è¿›åˆ¶ä»£ç èƒŒæ™¯ */
    body::after {
      content: '58b1747c 0dfc6175 e1bd0991 d801758 da0c6ee 954d6f19 94ed0d84';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.1);
      opacity: 0.3;
      z-index: 0;
      pointer-events: none;
      transform: rotate(-15deg);
      letter-spacing: 20px;
      line-height: 40px;
      white-space: pre-wrap;
    }

    .screen {
      display: none;
      position: relative;
      z-index: 10;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .active {
      display: flex !important;
    }
    
    .screen.active {
      display: flex !important;
    }

    /* ä¸­å¤®æ¨¡æ€çª—å£ */
    .modal {
      background: rgba(20, 20, 20, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      max-width: 1000px; /*é¦–é¡µç»¿è‰²æ¡†çš„å®½åº¦*/
      width: 100%;
      text-align: center;
      position: relative;
      border: 1px solid rgba(88, 177, 116, 0.3);
      box-shadow: 0 0 30px rgba(88, 177, 116, 0.2);
    }

    /* é¡¶éƒ¨å›¾æ ‡ */
    .top-icons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .icon {
      color: #58b174;
      font-size: 20px;
      opacity: 0.8;
    }

    /* ä¸»å›¾æ ‡ */
    .main-icon {
      font-size: 60px;
      color: #58b174;
      margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(88, 177, 116, 0.5);
    }

    /* æ ‡é¢˜æ ·å¼ */
    h1 {
      color: #58b174;
      font-size: 3.5em;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 0 0 10px rgba(88, 177, 116, 0.3);
    }

    .subtitle {
      color: #cccccc;
      font-size: 1.5em;
      margin-bottom: 8px;
    }

    .subtitle-italic {
      color: #cccccc;
      font-size: 1.3em;
      font-style: italic;
      margin-bottom: 30px;
    }

    .instruction {
      color: #cccccc;
      font-size: 1.6em;
      margin-bottom: 30px;
    }

    /* ä¼ æ„Ÿå™¨å›¾å½¢ */
    .sensor-area {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sensor-outer {
      width: 100%;
      height: 100%;
      border: 3px solid #2d5a3d;
      border-radius: 50%;
      position: absolute;
      animation: pulse 2s ease-in-out infinite;
    }

    .sensor-inner {
      width: 80px;
      height: 80px;
      border: 2px solid #58b174;
      border-radius: 50%;
      position: absolute;
      animation: pulse 2s ease-in-out infinite 0.5s;
    }

    .sensor-center {
      width: 20px;
      height: 20px;
      background: #58b174;
      border-radius: 50%;
      position: absolute;
      box-shadow: 0 0 20px rgba(88, 177, 116, 0.8);
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(88, 177, 116, 0.8); }
      50% { box-shadow: 0 0 30px rgba(88, 177, 116, 1); }
    }

    .status-text {
      color: #58b174;
      font-size: 1.3em;
      font-style: italic;
      margin-bottom: 30px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .resonance-btn {
      background: linear-gradient(90deg, #2d5a3d 0%, #58b174 100%);
      border: none;
      border-radius: 10px;
      padding: 20px 50px;
      color: white;
      font-size: 1.6em;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(88, 177, 116, 0.3);
    }

    .resonance-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(88, 177, 116, 0.4);
    }

    .resonance-btn::before,
    .resonance-btn::after {
      content: 'âš¡';
      color: #58b174;
      font-size: 0.8em;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }

    .resonance-btn::before {
      left: 15px;
    }

    .resonance-btn::after {
      right: 15px;
    }

    /* å€’è®¡æ—¶é¡µé¢ */
    #countdown {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
    }

    #countText {
      color: #58b174;
      font-size: 8em;
      font-weight: bold;
      text-shadow: 0 0 30px rgba(88, 177, 116, 0.5);
      animation: countdownPulse 1s ease-in-out;
    }

    @keyframes countdownPulse {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* é—®é¢˜é¡µé¢æ ·å¼ */
    .question-screen {
      background: #080d15;
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      max-width: 1000px;
      width: 100%;
      text-align: center;
      border: 2px solid #1b5a4b;
      position: relative;
    }

    /* è¿›åº¦æ¡å®¹å™¨ */
    .progress-container {
      position: absolute;
      top: -25px;
      left: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* è¿›åº¦æ¡ */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: #14b8a4;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* è¿›åº¦æ–‡æœ¬ */
    .progress-text {
      color: #cccccc;
      font-size: 0.8em;
      font-weight: 500;
    }

    /* é­”æ³•æ°´æ™¶çƒ */
    .crystal-ball-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 25px;
    }

    .crystal-ball {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at 30% 30%, rgba(88, 177, 116, 0.8), rgba(88, 177, 116, 0.3));
      border-radius: 50%;
      position: relative;
      box-shadow: 
        0 0 30px rgba(88, 177, 116, 0.6),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
      animation: crystalGlow 3s ease-in-out infinite;
      overflow: hidden;
    }

    /* æ°´æ™¶çƒå†…çš„å›¾æ ‡ */
    .crystal-icon {
      position: absolute;
      font-size: 1.2em;
      color: white;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
      opacity: 0;
      animation: iconAppear 1s ease-in-out forwards;
      animation-fill-mode: forwards;
    }

    @keyframes iconAppear {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.3);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* å›¾æ ‡ä½ç½® */
    .crystal-icon:nth-child(1) { top: 15%; left: 20%; }
    .crystal-icon:nth-child(2) { top: 15%; right: 20%; }
    .crystal-icon:nth-child(3) { top: 50%; left: 15%; }
    .crystal-icon:nth-child(4) { top: 50%; right: 15%; }
    .crystal-icon:nth-child(5) { bottom: 20%; left: 50%; transform: translateX(-50%); }

    /* æ°´æ™¶çƒå‘å…‰ç‰¹æ•ˆ */
    .crystal-ball.intense-glow {
      animation: intenseGlow 2s ease-in-out;
    }

    @keyframes intenseGlow {
      0% { 
        box-shadow: 
          0 0 30px rgba(88, 177, 116, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.1);
      }
      50% { 
        box-shadow: 
          0 0 80px rgba(88, 177, 116, 1),
          0 0 120px rgba(88, 177, 116, 0.8),
          inset 0 0 40px rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      100% { 
        box-shadow: 
          0 0 30px rgba(88, 177, 116, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.1);
        transform: scale(1);
      }
    }

    .crystal-ball::before {
      content: '';
      position: absolute;
      top: 20%;
      left: 25%;
      width: 15px;
      height: 15px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .crystal-ball::after {
      content: '';
      position: absolute;
      bottom: 30%;
      right: 20%;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
    }

    @keyframes crystalGlow {
      0%, 100% { 
        box-shadow: 
          0 0 30px rgba(88, 177, 116, 0.6),
          inset 0 0 20px rgba(255, 255, 255, 0.1);
      }
      50% { 
        box-shadow: 
          0 0 50px rgba(88, 177, 116, 0.8),
          inset 0 0 30px rgba(255, 255, 255, 0.2);
      }
    }

    .crystal-stand {
      width: 40px;
      height: 12px;
      background: linear-gradient(90deg, #2d5a3d, #58b174);
      border-radius: 6px;
      margin-top: 8px;
      box-shadow: 0 4px 15px rgba(88, 177, 116, 0.3);
    }

    .question-screen h2 {
      color: #58b174;
      font-size: 3em;
      margin-bottom: 25px;
    }

    .question-screen p {
      color: #ffffff;
      font-size: 1.8em;
      margin-bottom: 35px;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .option-btn {
      background: #080c13;
      border: 2px solid #374151;
      border-radius: 10px;
      padding: 20px 25px;
      color: #ffffff;
      font-size: 1.4em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .option-icon {
      font-size: 1.8em;
      min-width: 40px;
      text-align: center;
      text-shadow: 0 0 10px currentColor;
    }

    .option-btn:hover {
      background: #0c111b;
      border-color: #58b174;
      border-width: 2px;
      transform: translateX(5px);
    }

    /* ç”Ÿæˆé¡µé¢ */
    #generating {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
    }

    #generating h2 {
      color: #58b174;
      font-size: 3em;
      animation: generatingPulse 2s ease-in-out infinite;
    }

    @keyframes generatingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* ç»“æœé¡µé¢ */
    #result {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
    }

    #result h2 {
      color: #58b174;
      font-size: 3em;
      margin-bottom: 35px;
    }

    #poemText {
      color: #cccccc;
      font-size: 1.6em;
      line-height: 1.8;
      white-space: pre-wrap;
      text-align: left;
      background: rgba(88, 177, 116, 0.1);
      padding: 25px;
      border-radius: 10px;
      border: 1px solid rgba(88, 177, 116, 0.3);
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

<!-- Welcome Page -->
<div class="screen active" id="welcome">
  <div class="modal">
    <div class="top-icons">
      <span class="icon">&lt; &gt;</span>
      <span class="icon">â˜…</span>
    </div>
    <!-- Countdown Page -->
    <h1>Poetic Mind</h1>
    <p class="subtitle">Unlocking the frequencies of your mood</p>
    <p class="subtitle-italic">Where every pulse creates a verse</p>
    <p class="instruction">Place your left hand upon the sensors</p>
    <div class="sensor-area">
      <div class="sensor-outer"></div>
      <div class="sensor-inner"></div>
      <div class="sensor-center"></div>
    </div>
    <p class="status-text">Initiating bio-feedback scan...</p>
    <button class="resonance-btn" onclick="startCountdown()">BEGIN RESONANCE</button>
  </div>
</div>

<!-- Countdown Page -->
<div class="screen" id="countdown">
  <h2 id="countText">3</h2>
</div>

<!-- Q1 -->
<div class="screen" id="q1">
  <div class="question-screen">
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 20%;"></div>
      </div>
    </div>
    <div class="crystal-ball-container">
      <div class="crystal-ball"></div>
      <div class="crystal-stand"></div>
    </div>
    <p>How are you feeling right now?</p>
    <div class="options">
      <button class="option-btn" onclick="selectAnswer(1,'A')">
        <span class="option-icon" style="color: #58b174;">â˜ª</span>
        <span>Peaceful and content.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(1,'B')">
        <span class="option-icon" style="color: #58b174;">â˜…</span>
        <span>Happy and energetic.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(1,'C')">
        <span class="option-icon" style="color: #58b174;">â˜</span>
        <span>A little sad or thoughtful.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(1,'D')">
        <span class="option-icon" style="color: #58b174;">ğŸ—º</span>
        <span>Curious and adventurous.</span>
      </button>
    </div>
  </div>
</div>

<!-- Q2 -->
<div class="screen" id="q2">
  <div class="question-screen">
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 40%;"></div>
      </div>
    </div>
    <div class="crystal-ball-container">
      <div class="crystal-ball"></div>
      <div class="crystal-stand"></div>
    </div>
    <p>Which landscape best reflects your current state of mind?</p>
    <div class="options">
      <button class="option-btn" onclick="selectAnswer(2,'A')">
        <span class="option-icon" style="color: #58b174;">â</span>
        <span>A quiet, sunlit forest.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(2,'B')">
        <span class="option-icon" style="color: #58b174;">âœ§</span>
        <span>A bustling, vibrant city at night.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(2,'C')">
        <span class="option-icon" style="color: #58b174;">â—’ </span>
        <span>A calm, misty coastline.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(2,'D')">
        <span class="option-icon" style="color: #58b174;">â–²</span>
        <span>A looming mountain scape.</span>
      </button>
    </div>
  </div>
</div>

<!-- Q3 -->
<div class="screen" id="q3">
  <div class="question-screen">
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 60%;"></div>
      </div>
    </div>
    <div class="crystal-ball-container">
      <div class="crystal-ball"></div>
      <div class="crystal-stand"></div>
    </div>
    <p>If your feelings were a sound, what would they be?</p>
    <div class="options">
      <button class="option-btn" onclick="selectAnswer(3,'A')">
        <span class="option-icon" style="color: #58b174;">â˜‚</span>
        <span>The gentle rhythm of rain on a window.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(3,'B')">
        <span class="option-icon" style="color: #58b174;">â™«</span>
        <span>A joyful, upbeat melody.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(3,'C')">
        <span class="option-icon" style="color: #58b174;">â˜¾</span>
        <span>The quiet hum of a sleeping city.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(3,'D')">
        <span class="option-icon" style="color: #58b174;">âš¡</span>
        <span>The sound of distant, rolling thunder.</span>
      </button>
    </div>
  </div>
</div>

<!-- Q4 -->
<div class="screen" id="q4">
  <div class="question-screen">
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 80%;"></div>
      </div>
    </div>
    <div class="crystal-ball-container">
      <div class="crystal-ball"></div>
      <div class="crystal-stand"></div>
    </div>
    <p>Choose a color that best represents your mood today.</p>
    <div class="options">
      <button class="option-btn" onclick="selectAnswer(4,'A')">
        <span class="option-icon" style="color: #58b174;">â™›</span>
        <span>Soft, warm yellows and golds.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(4,'B')">
        <span class="option-icon" style="color: #58b174;">â†“</span>
        <span>Deep, contemplative blues and purples.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(4,'C')">
        <span class="option-icon" style="color: #58b174;">â—</span>
        <span>Bright, energetic reds and oranges.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(4,'D')">
        <span class="option-icon" style="color: #58b174;">â˜€</span>
        <span>Muted, earthy greens and browns.</span>
      </button>
    </div>
  </div>
</div>

<!-- Q5 -->
<div class="screen" id="q5">
  <div class="question-screen">
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 100%;"></div>
      </div>
    </div>
    <div class="crystal-ball-container">
      <div class="crystal-ball"></div>
      <div class="crystal-stand"></div>
    </div>
    <p>What kind of story would you like your poem to tell?</p>
    <div class="options">
      <button class="option-btn" onclick="selectAnswer(5,'A')">
        <span class="option-icon" style="color: #58b174;">â™¡</span>
        <span>A story of quiet reflection and memory.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(5,'B')">
        <span class="option-icon" style="color: #58b174;">â˜†</span>
        <span>A celebration of a simple, beautiful moment.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(5,'C')">
        <span class="option-icon" style="color: #58b174;">âš™</span>
        <span>An exploration of a deep and complex emotion.</span>
      </button>
      <button class="option-btn" onclick="selectAnswer(5,'D')">
        <span class="option-icon" style="color: #58b174;">â– </span>
        <span>A tale of adventure and the unknown.</span>
      </button>
    </div>
  </div>
</div>

<!-- Loading Page -->
<div class="screen" id="generating">
  <h2>Your poem is compiling...</h2>
</div>

<!-- Result Page -->
<div class="screen" id="result">  
  <div class="question-screen" style="max-width: 900px;">
    <h2>Your personalized poem:</h2>
    <pre id="poemText"></pre>
    
    <!-- New Try Again Button -->
    <!--<button class="resonance-btn" style="margin-top: 30px;" onclick="location.reload()">Try Again</button>-->
  </div>
</div>


<script>
let answers = {};
let currentQ = 0;
let selectedIcons = []; // å­˜å‚¨é€‰ä¸­çš„å›¾æ ‡

// å›¾æ ‡æ˜ å°„è¡¨
const iconMap = {
  '1A': 'â˜ª', // ä¼Šæ–¯å…°æ–°æœˆ
  '1B': 'â˜…', // æ˜Ÿæ˜Ÿ
  '1C': 'â˜', // äº‘æœµ
  '1D': 'ğŸ—º', // åœ°å›¾
  '2A': 'â', // èŠ±æœµ
  '2B': 'âœ§', // æ˜Ÿæ˜Ÿ
  '2C': 'â—’', // åœ†å½¢
  '2D': 'â–²', // ä¸‰è§’å½¢
  '3A': 'â˜‚', // é›¨ä¼
  '3B': 'â™«', // éŸ³ç¬¦
  '3C': 'â˜¾', // æœˆäº®
  '3D': 'âš¡', // é—ªç”µ
  '4A': 'â™›', // çš‡å† 
  '4B': 'â†“', // ç®­å¤´
  '4C': 'â—', // å®å¿ƒåœ†
  '4D': 'â˜€', // å¤ªé˜³
  '5A': 'â™¡', // çˆ±å¿ƒ
  '5B': 'â˜†', // ç©ºå¿ƒæ˜Ÿ
  '5C': 'âš™', // é½¿è½®
  '5D': 'â– '  // æ–¹å—
};

function show(id) {
  document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startCountdown() {
  console.log('Button clicked! Starting countdown...');
  fetch('/start', {method: 'POST'});
  show('countdown');
  let count = 3;
  const timer = setInterval(() => {
    count--;
    document.getElementById('countText').textContent = count;
    if (count === 0) {
      clearInterval(timer);
      show('q1');
    }
  }, 1000);
}

function addIconToCrystalBall(questionNum, choice) {
  const iconKey = questionNum + choice;
  const icon = iconMap[iconKey];
  
  if (icon) {
    selectedIcons.push(icon);
    
    // ä¸ºå½“å‰é—®é¢˜åŠåç»­é—®é¢˜çš„æ°´æ™¶çƒæ·»åŠ å›¾æ ‡
    for (let i = questionNum; i <= 5; i++) {
      const crystalBall = document.querySelector(`#q${i} .crystal-ball`);
      if (crystalBall) {
        // æ¸…é™¤ä¹‹å‰çš„å›¾æ ‡
        const existingIcons = crystalBall.querySelectorAll('.crystal-icon');
        existingIcons.forEach(icon => icon.remove());
        
        // æ·»åŠ æ‰€æœ‰å·²é€‰æ‹©çš„å›¾æ ‡ï¼Œä½†åªä¸ºæ–°æ·»åŠ çš„å›¾æ ‡è®¾ç½®åŠ¨ç”»
        selectedIcons.forEach((selectedIcon, index) => {
          const iconElement = document.createElement('div');
          iconElement.className = 'crystal-icon';
          iconElement.textContent = selectedIcon;
          
          // åªä¸ºæ–°æ·»åŠ çš„å›¾æ ‡ï¼ˆæœ€åä¸€ä¸ªï¼‰è®¾ç½®åŠ¨ç”»
          if (index === selectedIcons.length - 1) {
            iconElement.style.animationDelay = '0s';
          } else {
            // å¯¹äºä¹‹å‰å·²å­˜åœ¨çš„å›¾æ ‡ï¼Œç›´æ¥è®¾ç½®ä¸ºæœ€ç»ˆçŠ¶æ€
            iconElement.style.animation = 'none';
            iconElement.style.opacity = '1';
            iconElement.style.transform = 'scale(1)';
          }
          
          crystalBall.appendChild(iconElement);
        });
        
        // è§¦å‘å‘å…‰ç‰¹æ•ˆ
        crystalBall.classList.add('intense-glow');
        setTimeout(() => {
          crystalBall.classList.remove('intense-glow');
        }, 2000);
      }
    }
  }
}

function generateDefaultPoem(answers) {
  // æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ç”Ÿæˆä¸ªæ€§åŒ–çš„é»˜è®¤è¯—æ­Œ
  const themes = {
    'Q1': {
      'A': 'peaceful',
      'B': 'joyful', 
      'C': 'contemplative',
      'D': 'adventurous'
    },
    'Q2': {
      'A': 'nature',
      'B': 'urban',
      'C': 'serene',
      'D': 'majestic'
    },
    'Q3': {
      'A': 'gentle',
      'B': 'melodic',
      'C': 'quiet',
      'D': 'powerful'
    },
    'Q4': {
      'A': 'warm',
      'B': 'deep',
      'C': 'vibrant',
      'D': 'earthy'
    },
    'Q5': {
      'A': 'reflective',
      'B': 'celebratory',
      'C': 'explorative',
      'D': 'adventurous'
    }
  };

  const mood = themes.Q1[answers.Q1] || 'peaceful';
  const landscape = themes.Q2[answers.Q2] || 'nature';
  const sound = themes.Q3[answers.Q3] || 'gentle';
  const color = themes.Q4[answers.Q4] || 'warm';
  const story = themes.Q5[answers.Q5] || 'reflective';

  // æ›´ä¸°å¯Œçš„è¯—æ­Œåº“
  const poemLibrary = {
    peaceful: {
      nature: {
        gentle: {
          warm: {
            reflective: `In the quiet morning light,\nSoft whispers of the breeze,\nNature's gentle embrace,\nBrings inner peace.`
          },
          deep: {
            reflective: `Golden sunlight filters through,\nAncient trees stand tall and true,\nIn this sacred space of calm,\nTime slows down like morning dew.`
          }
        }
      },
      serene: {
        quiet: {
          deep: {
            reflective: `Mist rolls gently over hills,\nOcean waves in rhythmic thrills,\nIn this moment, pure and still,\nPeace flows like a mountain rill.`
          }
        }
      }
    },
    joyful: {
      urban: {
        melodic: {
          vibrant: {
            celebratory: `City lights dance and shine,\nMusic fills the air divine,\nJoy in every moment shared,\nLife is beautiful and rare.`
          }
        }
      }
    },
    contemplative: {
      serene: {
        quiet: {
          deep: {
            explorative: `Thoughts drift like clouds above,\nIn the quiet night of love,\nDeep within the soul's embrace,\nWisdom takes its rightful place.`
          }
        }
      }
    },
    adventurous: {
      majestic: {
        powerful: {
          earthy: {
            adventurous: `Mountains call your name aloud,\nAdventure waits beyond the cloud,\nCourage burns within your heart,\nStories yet to play their part.`
          }
        }
      }
    }
  };

  // å°è¯•æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„è¯—æ­Œ
  let poem = poemLibrary[mood]?.[landscape]?.[sound]?.[color]?.[story];
  
  // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•éƒ¨åˆ†åŒ¹é…
  if (!poem) {
    // åŸºäºä¸»è¦æƒ…ç»ªç”Ÿæˆè¯—æ­Œ
    const moodPoems = {
      peaceful: `In the gentle morning light,\nSoft whispers of the breeze,\nNature's gentle embrace,\nBrings inner peace.`,
      joyful: `Joy bubbles like a spring,\nLaughter fills the air,\nEvery moment is a gift,\nLife beyond compare.`,
      contemplative: `Thoughts drift like autumn leaves,\nIn the quiet of the mind,\nDeep within the soul's embrace,\nWisdom we are meant to find.`,
      adventurous: `Mountains call your name,\nAdventure waits ahead,\nCourage in your heart,\nStories yet untold.`
    };
    
    poem = moodPoems[mood] || `Based on your choices,\nA unique poem unfolds,\nReflecting your spirit,\nIn words yet untold.`;
  }

  return poem;
}

function selectAnswer(qNum, choice) {
  // æ·»åŠ å›¾æ ‡åˆ°æ°´æ™¶çƒ
  addIconToCrystalBall(qNum, choice);
  
  answers['Q' + qNum] = choice;
  currentQ++;
  
  // å»¶è¿Ÿä¸€ä¸‹å†è·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰ä¸­æ•ˆæœå’Œå‘å…‰ç‰¹æ•ˆ
  setTimeout(() => {
    if (currentQ < 5) {
      show('q' + (currentQ + 1));
    } else {
      show('generating');
      
      // åœ¨ç”Ÿæˆé¡µé¢æ·»åŠ äº”ä¸ªå›¾æ ‡åˆ°æ°´æ™¶çƒ
      const generatingCrystalBall = document.getElementById('generating-crystal-ball');
      const generatingCrystalIconsContainer = document.getElementById('generating-crystal-icons-container');
      if (generatingCrystalBall && generatingCrystalIconsContainer && selectedIcons.length > 0) {
        // æ¸…é™¤ç°æœ‰å›¾æ ‡
        generatingCrystalIconsContainer.innerHTML = '';
        
        // æ·»åŠ æ‰€æœ‰äº”ä¸ªå›¾æ ‡åˆ°å®¹å™¨ä¸­
        selectedIcons.forEach((icon, index) => {
          const iconElement = document.createElement('div');
          iconElement.className = 'generating-crystal-icon';
          iconElement.textContent = icon;
          generatingCrystalIconsContainer.appendChild(iconElement);
        });
      }
      
      // åœç•™2ç§’åå¤„ç†è¯—æ­Œç”Ÿæˆå’Œé¡µé¢è·³è½¬
      setTimeout(() => {
        fetch('/submit_answers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers: answers })
        })
        .then(res => {
          console.log('Response status:', res.status);
          return res.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data && data.poem) {
            document.getElementById('poemText').textContent = data.poem;
          } else {
            console.log('No poem data in response, using default');
            const defaultPoem = generateDefaultPoem(answers);
            document.getElementById('poemText').textContent = defaultPoem;
          }
          console.log('Showing result page');
          show('result');

          // å¼ºåˆ¶ç¡®ä¿ç»“æœé¡µé¢æ˜¾ç¤º
          setTimeout(() => {
            if (!document.getElementById('result').classList.contains('active')) {
              console.log('Forcing result page display');
              show('result');
            }
          }, 100);

          // âœ… 2ç§’åè‡ªåŠ¨æ˜¾ç¤º Try Again æŒ‰é’®
          setTimeout(() => {
            const btn = document.createElement('button');
            btn.className = 'resonance-btn';
            btn.textContent = 'Try Again';
            btn.onclick = () => location.reload();
            document.querySelector('#result .question-screen').appendChild(btn);
          }, 2000);
        })
        .catch(error => {
          console.error('Error fetching poem:', error);
          // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé»˜è®¤è¯—æ­Œ
          const defaultPoem = generateDefaultPoem(answers);
          document.getElementById('poemText').textContent = defaultPoem;
          show('result');

          // 2ç§’åè‡ªåŠ¨æ˜¾ç¤º Try Again æŒ‰é’®
          setTimeout(() => {
            const btn = document.createElement('button');
            btn.className = 'resonance-btn';
            btn.textContent = 'Try Again';
            btn.onclick = () => location.reload();
            document.querySelector('#result .question-screen').appendChild(btn);
          }, 2000);
        });
      }, 2000); // ç”Ÿæˆé¡µé¢åœç•™2ç§’
    }
  }, 1000); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å‘å…‰ç‰¹æ•ˆ
}
</script>

</body>
</html>
